name: Test Build Workflow

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - macos
          - windows
          - linux
      build_type:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.mm'
      - '**.cmake'
      - 'CMakeLists.txt'
      - '.github/workflows/test-build.yml'

env:
  BUILD_DIR: build
  JUCE_VERSION: 7.0.5

jobs:
  test-macos:
    name: Test macOS Build
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' || github.event_name == 'pull_request' }}
    runs-on: macos-14  # Pin to macOS 14 - JUCE 7.0.5 incompatible with macOS 15 APIs

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Workflow info
      run: |
        echo "Running macOS test build"
        echo "Build type: ${{ github.event.inputs.build_type }}"

    - name: Install tools
      run: |
        brew update
        brew install cmake ninja || true

    - name: Configure
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'Release' }}"
        cmake -B ${{ env.BUILD_DIR }} -G Ninja -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

    - name: Build
      run: cmake --build ${{ env.BUILD_DIR }}

    - name: Find artifacts
      run: |
        find ${{ env.BUILD_DIR }} -maxdepth 4 -type d -name "*.app" || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-build-macos-${{ github.run_number }}
        path: ${{ env.BUILD_DIR }}/**/*.app
        retention-days: 3

  test-windows:
    name: Test Windows Build
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' || github.event_name == 'pull_request' }}
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build with Visual Studio 2022
      run: |
        cd Builds\VisualStudio2022
        $CONFIG = "${{ github.event.inputs.build_type }}"
        if ([string]::IsNullOrEmpty($CONFIG)) { $CONFIG = "Release" }
        # Build shared code and helpers first
        msbuild ShowMIDI_SharedCode.vcxproj /p:Configuration=$CONFIG /p:Platform=x64
        msbuild ShowMIDI_VST3ManifestHelper.vcxproj /p:Configuration=$CONFIG /p:Platform=x64
        # Build plugin targets (skip VST2 - requires proprietary SDK)
        msbuild ShowMIDI_StandalonePlugin.vcxproj /p:Configuration=$CONFIG /p:Platform=x64
        msbuild ShowMIDI_VST3.vcxproj /p:Configuration=$CONFIG /p:Platform=x64

    - name: Verify build artifacts
      run: |
        $CONFIG = "${{ github.event.inputs.build_type }}"
        if ([string]::IsNullOrEmpty($CONFIG)) { $CONFIG = "Release" }
        $exePath = "Builds\VisualStudio2022\x64\$CONFIG\Standalone Plugin\ShowMIDI.exe"
        if (Test-Path $exePath) {
          Write-Host "✅ Build succeeded: $exePath"
        } else {
          Write-Host "❌ Build artifact not found: $exePath"
          exit 1
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-build-windows-${{ github.run_number }}
        path: |
          Builds/VisualStudio2022/x64/**/*.exe
          Builds/VisualStudio2022/x64/**/*.vst3
        retention-days: 3

  test-linux:
    name: Test Linux Build
    if: ${{ github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux' || github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build \
          libasound2-dev libx11-dev libfreetype6-dev \
          libxrandr-dev libxinerama-dev libxcursor-dev || true

    - name: Configure & build
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'Release' }}"
        cmake -B ${{ env.BUILD_DIR }} -G Ninja -DCMAKE_BUILD_TYPE=${BUILD_TYPE}
        cmake --build ${{ env.BUILD_DIR }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-build-linux-${{ github.run_number }}
        path: ${{ env.BUILD_DIR }}/**/ShowMIDI*
        retention-days: 3

  test-summary:
    name: Test Summary
    if: always()
    needs: [test-macos, test-windows, test-linux]
    runs-on: ubuntu-latest
    steps:
    - name: Summary
      run: |
        echo "# Test Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | ${{ needs.test-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | ${{ needs.test-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | ${{ needs.test-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Test build completed"