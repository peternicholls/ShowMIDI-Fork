name: CI

# CI Workflow: Validates all code changes across Linux, macOS, and Windows platforms.
# Triggers on PRs to develop/main and pushes to production branches (main, release/*, hotfix/*).
# 
# Path Filtering: Documentation-only changes (*.md, docs/, LICENSE files) skip heavy build jobs
# to save CI resources and provide faster feedback. Code changes always trigger full validation.
# This reduces PR wait time from ~15min to <30s for documentation updates.
on:
  # PRs to develop or main trigger full validation
  pull_request:
    branches:
      - develop
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - 'COPYING.md'
  
  # Pushes to main (production) trigger full validation
  push:
    branches:
      - main
      - 'release/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
  
  # Manual trigger for testing
  workflow_dispatch:

# Concurrency Control: Cancel in-progress workflow runs when new commits are pushed to the same branch.
# This prevents wasting CI resources on outdated code and reduces wait time for developers.
# Example: If you push commits A, then B rapidly, the workflow for commit A is cancelled automatically.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Config Loader: Parse testing-governance.yaml to read time budgets and check configurations
  # This job runs first and provides configuration values as outputs for downstream jobs
  config-loader:
    name: Load Testing Configuration
    runs-on: ubuntu-latest
    outputs:
      unit_tests_timeout_sec: ${{ steps.parse-config.outputs.unit_tests_timeout_sec }}
      integration_tests_timeout_sec: ${{ steps.parse-config.outputs.integration_tests_timeout_sec }}
      pr_time_budget_min: ${{ steps.parse-config.outputs.pr_time_budget_min }}
      pr_time_budget_p95_min: ${{ steps.parse-config.outputs.pr_time_budget_p95_min }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install yq (YAML parser)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Parse testing-governance.yaml
        id: parse-config
        run: |
          CONFIG_FILE=".github/testing-governance.yaml"
          
          # Extract timeout values from check categories (in seconds)
          UNIT_TIMEOUT=$(yq eval '.check_categories[] | select(.id == "unit-tests") | .timeout_sec' "$CONFIG_FILE")
          INTEGRATION_TIMEOUT=$(yq eval '.check_categories[] | select(.id == "integration-tests") | .timeout_sec' "$CONFIG_FILE")
          
          # Extract time budgets from pr-to-develop trigger context (in seconds)
          PR_BUDGET=$(yq eval '.trigger_contexts[] | select(.id == "pr-to-develop") | .time_budget_sec' "$CONFIG_FILE")
          PR_BUDGET_P95=$(yq eval '.trigger_contexts[] | select(.id == "pr-to-develop") | .time_budget_p95_sec' "$CONFIG_FILE")
          
          # Set outputs (keep seconds for ctest, convert to minutes for timeout-minutes)
          echo "unit_tests_timeout_sec=$UNIT_TIMEOUT" >> $GITHUB_OUTPUT
          echo "integration_tests_timeout_sec=$INTEGRATION_TIMEOUT" >> $GITHUB_OUTPUT
          echo "pr_time_budget_min=$((PR_BUDGET_P95 / 60))" >> $GITHUB_OUTPUT
          echo "pr_time_budget_p95_min=$((PR_BUDGET_P95 / 60))" >> $GITHUB_OUTPUT
          
          # Display parsed values for debugging
          echo "✅ Configuration loaded:"
          echo "  Unit tests timeout: ${UNIT_TIMEOUT}s"
          echo "  Integration tests timeout: ${INTEGRATION_TIMEOUT}s"
          echo "  PR time budget (median): ${PR_BUDGET}s"
          echo "  PR time budget (p95): ${PR_BUDGET_P95}s ($(($PR_BUDGET_P95 / 60)) min)"

  code-quality:
    name: Code Quality Checks
    needs: config-loader  # Load configuration before running checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
            libasound2-dev libfreetype-dev libfreetype6-dev libfontconfig1-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev
      
      - name: Check GPL-3.0 headers
        run: |
          echo "Checking for GPL-3.0 license headers in source files..."
          missing_headers=0
          for file in $(find Source -name "*.cpp" -o -name "*.h"); do
            if ! grep -q "GNU General Public License" "$file"; then
              echo "❌ Missing GPL-3.0 header: $file"
              missing_headers=$((missing_headers + 1))
            fi
          done
          if [ $missing_headers -gt 0 ]; then
            echo "⚠️  Found $missing_headers files without GPL-3.0 headers"
            echo "This is a warning, not blocking the build"
          else
            echo "✅ All source files have GPL-3.0 headers"
          fi
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
        env:
          CPLUS_INCLUDE_PATH: /usr/include/freetype2
          C_INCLUDE_PATH: /usr/include/freetype2
      
      - name: Build (warnings as errors)
        run: |
          cd build
          cmake --build . --config Release
        env:
          CPLUS_INCLUDE_PATH: /usr/include/freetype2
          C_INCLUDE_PATH: /usr/include/freetype2

  build-and-test-macos:
    name: Build and Test (macOS)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: macos-14  # Pin to macOS 14 - JUCE 7.0.5 doesn't support macOS 15 API deprecations
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # CMake-based build: Uses CMake instead of Xcode projects to avoid
      # hardcoded absolute path issues in .xcodeproj files. CMake generates
      # build files with correct relative paths on any machine.
      - name: Install dependencies
        run: |
          brew install cmake ninja
      
      # T026: Cache configuration for JUCE builds (reduces build time from ~5 min to ~2 min on cache hit)
      - name: Cache CMake build files
        uses: actions/cache@v4
        with:
          path: |
            build/CMakeCache.txt
            build/CMakeFiles
            build/_deps
          key: ${{ runner.os }}-cmake-release-${{ hashFiles('**/CMakeLists.txt', 'JUCE/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-release-
      
      - name: Cache JUCE modules
        uses: actions/cache@v4
        with:
          path: |
            JUCE/modules
            JuceLibraryCode
          key: ${{ runner.os }}-juce-${{ hashFiles('showmidi.jucer', 'JUCE/VERSION') }}
          restore-keys: |
            ${{ runner.os }}-juce-
      
      - name: Display build environment
        run: |
          echo "CMake version: $(cmake --version | head -1)"
          echo "Ninja version: $(ninja --version)"
          xcodebuild -version
          echo "Xcode developer directory: $(xcode-select --print-path)"
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
      
      - name: Build with CMake
        run: |
          cd build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
      
      - name: Smoke Test (Verify artifacts)
        run: |
          echo "Checking for build artifacts..."
          
          # Find and list generated artifacts
          echo "Searching for .app bundles..."
          find build -name "*.app" -type d || echo "No .app bundles found"
          
          echo "Searching for .vst3 plugins..."
          find build -name "*.vst3" -type d || echo "No .vst3 plugins found"
          
          echo "Searching for .component plugins..."
          find build -name "*.component" -type d || echo "No .component plugins found"
          
          # Verify at least one artifact exists
          if find build -name "*.app" -type d -o -name "*.vst3" -type d -o -name "*.component" -type d | grep -q .; then
            echo "✅ Build artifacts found"
          else
            echo "❌ No build artifacts found"
            exit 1
          fi
      
      # Artifact Retention Policy: Build artifacts (app bundles, plugins) are kept for 90 days.
      # This allows sufficient time for testing and distribution while managing storage costs.
      # Artifacts are automatically deleted after the retention period expires.
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-macOS
          retention-days: 90
          if-no-files-found: ignore
          path: |
            build/**/*.app
            build/**/*.vst3
            build/**/*.component

  build-windows:
    name: Build (Windows)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: windows-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # T026: Cache configuration for JUCE builds
      - name: Cache CMake build files
        uses: actions/cache@v4
        with:
          path: |
            build/CMakeCache.txt
            build/CMakeFiles
            build/_deps
          key: ${{ runner.os }}-cmake-release-${{ hashFiles('**/CMakeLists.txt', 'JUCE/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-release-
      
      - name: Cache JUCE modules
        uses: actions/cache@v4
        with:
          path: |
            JUCE/modules
            JuceLibraryCode
          key: ${{ runner.os }}-juce-${{ hashFiles('showmidi.jucer', 'JUCE/VERSION') }}
          restore-keys: |
            ${{ runner.os }}-juce-
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
      
      - name: Build with CMake
        run: |
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS
      
      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          if (Test-Path "build\ShowMIDI_artefacts\Release\Standalone\ShowMIDI.exe") {
            Write-Host "✅ ShowMIDI.exe created successfully"
          } else {
            Write-Host "⚠️  ShowMIDI.exe not found at expected location"
            Write-Host "Searching for build artifacts..."
            Get-ChildItem -Recurse -Path build -Include *.exe,*.vst3,*.dll | Select-Object -First 10
          }
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-Windows
          retention-days: 90
          if-no-files-found: ignore
          path: |
            build/ShowMIDI_artefacts/Release/**/*
            build/**/*.vst3
            build_clap/ShowMIDI_artefacts/Release/*.clap

  build-linux:
    name: Build (Linux)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config cmake \
            libasound2-dev libfreetype6-dev libfontconfig1-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev
      
      # T026: Cache configuration for JUCE builds
      - name: Cache CMake build files
        uses: actions/cache@v4
        with:
          path: |
            build/CMakeCache.txt
            build/CMakeFiles
            build/_deps
          key: ${{ runner.os }}-cmake-release-${{ hashFiles('**/CMakeLists.txt', 'JUCE/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-release-
      
      - name: Cache JUCE modules
        uses: actions/cache@v4
        with:
          path: |
            JUCE/modules
            JuceLibraryCode
          key: ${{ runner.os }}-juce-${{ hashFiles('showmidi.jucer', 'JUCE/VERSION') }}
          restore-keys: |
            ${{ runner.os }}-juce-
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j$(nproc)
      
      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          if [ -f "build/ShowMIDI_artefacts/Release/Standalone/ShowMIDI" ]; then
            echo "✅ ShowMIDI standalone binary created"
          else
            echo "⚠️  ShowMIDI standalone binary not found at expected location"
            echo "Searching for build artifacts..."
            find build -name "ShowMIDI" -o -name "*.so" -o -name "*.vst3"
          fi
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-Linux
          retention-days: 90
          if-no-files-found: ignore
          path: |
            build/ShowMIDI_artefacts/Release/**/*
            build_clap/ShowMIDI_artefacts/Release/*.clap

  # Test jobs: Run automated test suite on all platforms
  # Phase 4 (User Story 2): Cross-platform test execution with fail-fast and parallelization
  test-suite:
    name: Test (${{ matrix.os-name }})
    needs: [code-quality, config-loader]  # Fail-fast + load config for timeouts
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ fromJSON(needs.config-loader.outputs.pr_time_budget_p95_min) }}  # Dynamic timeout from config (p95 budget)
    strategy:
      fail-fast: true  # Abort remaining jobs if any platform fails (saves CI time, faster feedback per T021)
      matrix:
        include:
          # macOS is primary platform per research.md Decision 4 (T022: parallelization matrix)
          - os: macos-14
            os-name: macOS
            install-deps: brew install cmake ninja
            cmake-generator: -G Ninja
            test-config: ""
            parallel-flag: -j$(sysctl -n hw.ncpu)
          # Windows and Linux run in parallel with macOS
          - os: windows-latest
            os-name: Windows
            install-deps: ""
            cmake-generator: ""
            test-config: -C Debug
            parallel-flag: -j $env:NUMBER_OF_PROCESSORS
          - os: ubuntu-latest
            os-name: Linux
            install-deps: |
              sudo apt-get update
              sudo apt-get install -y build-essential pkg-config cmake libasound2-dev libfreetype6-dev libfontconfig1-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev
            cmake-generator: ""
            test-config: ""
            parallel-flag: -j$(nproc)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # T026: Cache configuration per research.md Decision 5 and testing-governance.yaml caching-strategy policy
      - name: Cache CMake build files
        uses: actions/cache@v4
        with:
          path: |
            build/CMakeCache.txt
            build/CMakeFiles
            build/_deps
          key: ${{ runner.os }}-cmake-${{ hashFiles('**/CMakeLists.txt', 'JUCE/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-
      
      - name: Cache JUCE modules
        uses: actions/cache@v4
        with:
          path: |
            JUCE/modules
            JuceLibraryCode
          key: ${{ runner.os }}-juce-${{ hashFiles('showmidi.jucer', 'JUCE/VERSION') }}
          restore-keys: |
            ${{ runner.os }}-juce-
      
      - name: Cache ccache (compiler cache)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-
      
      - name: Install dependencies
        if: matrix.install-deps != ''
        run: ${{ matrix.install-deps }}
      
      - name: Build tests
        run: |
          cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug ${{ matrix.cmake-generator }}
          cmake --build build --target ShowMIDI_Tests ${{ matrix.test-config }} ${{ matrix.parallel-flag }}
      
      - name: Run unit tests
        run: |
          cd build
          # T019-T020: Use timeout from config (in seconds)
          # T023: Timeout enforcement using config values
          ctest ${{ matrix.test-config }} -L unit --output-on-failure --timeout ${{ needs.config-loader.outputs.unit_tests_timeout_sec }}
      
      - name: Run integration tests
        run: |
          cd build
          # T019-T020: Use timeout from config (in seconds)
          # T023: Timeout enforcement using config values
          ctest ${{ matrix.test-config }} -L integration --output-on-failure --timeout ${{ needs.config-loader.outputs.integration_tests_timeout_sec }}
      
      - name: Run system tests
        run: |
          cd build
          ctest ${{ matrix.test-config }} -L system --output-on-failure --timeout 300
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os-name }}-${{ github.run_number }}
          retention-days: 90
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/*.xml

  build-ios:
    name: Build (iOS AUv3)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: macos-14  # Pin to macOS 14 for consistency with other macOS jobs
    # iOS build is optional - comment out if not needed
    if: false  # Enable this by changing to 'true' when iOS build is ready
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # Adaptive Xcode Selection: GitHub Actions runner images regularly update Xcode versions.
      # This step uses xcode-select to detect and verify the active Xcode installation,
      # preventing "invalid developer directory" errors when runners update.
      # The workflow automatically uses the latest available Xcode on the runner.
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Build iOS AUv3
        run: |
          cd Builds/iOS
          xcodebuild -project ShowMIDI.xcodeproj \
            -scheme "ShowMIDI - AUv3 AppExtension" \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-iOS
          path: Builds/iOS/build/Release-iphonesimulator/*.appex
