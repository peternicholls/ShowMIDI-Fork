name: CI

# CI Workflow: Validates all code changes across Linux, macOS, and Windows platforms.
# Triggers on PRs to develop/main and pushes to production branches (main, release/*, hotfix/*).
# 
# Path Filtering: Documentation-only changes (*.md, docs/, LICENSE files) skip heavy build jobs
# to save CI resources and provide faster feedback. Code changes always trigger full validation.
# This reduces PR wait time from ~15min to <30s for documentation updates.
on:
  # PRs to develop or main trigger full validation
  pull_request:
    branches:
      - develop
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - 'COPYING.md'
  
  # Pushes to main (production) trigger full validation
  push:
    branches:
      - main
      - 'release/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
  
  # Manual trigger for testing
  workflow_dispatch:

# Concurrency Control: Cancel in-progress workflow runs when new commits are pushed to the same branch.
# This prevents wasting CI resources on outdated code and reduces wait time for developers.
# Example: If you push commits A, then B rapidly, the workflow for commit A is cancelled automatically.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
            libasound2-dev libfreetype-dev libfreetype6-dev libfontconfig1-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev
      
      - name: Check GPL-3.0 headers
        run: |
          echo "Checking for GPL-3.0 license headers in source files..."
          missing_headers=0
          for file in $(find Source -name "*.cpp" -o -name "*.h"); do
            if ! grep -q "GNU General Public License" "$file"; then
              echo "❌ Missing GPL-3.0 header: $file"
              missing_headers=$((missing_headers + 1))
            fi
          done
          if [ $missing_headers -gt 0 ]; then
            echo "⚠️  Found $missing_headers files without GPL-3.0 headers"
            echo "This is a warning, not blocking the build"
          else
            echo "✅ All source files have GPL-3.0 headers"
          fi
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
        env:
          SHOWMIDI_WERROR: "1"  # Enable warnings-as-errors for ShowMIDI code
          CPLUS_INCLUDE_PATH: /usr/include/freetype2
          C_INCLUDE_PATH: /usr/include/freetype2
      
      - name: Build (warnings as errors)
        run: |
          cd build
          cmake --build . --config Release

  build-and-test-macos:
    name: Build and Test (macOS)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: macos-14  # Pin to macOS 14 - JUCE 7.0.5 doesn't support macOS 15 API deprecations
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # CMake-based build: Uses CMake instead of Xcode projects to avoid
      # hardcoded absolute path issues in .xcodeproj files. CMake generates
      # build files with correct relative paths on any machine.
      - name: Install dependencies
        run: |
          brew install cmake ninja
      
      - name: Display build environment
        run: |
          echo "CMake version: $(cmake --version | head -1)"
          echo "Ninja version: $(ninja --version)"
          xcodebuild -version
          echo "Xcode developer directory: $(xcode-select --print-path)"
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
      
      - name: Build with CMake
        run: |
          cd build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)
      
      - name: Smoke Test (Verify artifacts)
        run: |
          echo "Checking for build artifacts..."
          
          # Find and list generated artifacts
          echo "Searching for .app bundles..."
          find build -name "*.app" -type d || echo "No .app bundles found"
          
          echo "Searching for .vst3 plugins..."
          find build -name "*.vst3" -type d || echo "No .vst3 plugins found"
          
          echo "Searching for .component plugins..."
          find build -name "*.component" -type d || echo "No .component plugins found"
          
          # Verify at least one artifact exists
          if find build -name "*.app" -type d -o -name "*.vst3" -type d -o -name "*.component" -type d | grep -q .; then
            echo "✅ Build artifacts found"
          else
            echo "❌ No build artifacts found"
            exit 1
          fi
      
      # Artifact Retention Policy: Build artifacts (app bundles, plugins) are kept for 90 days.
      # This allows sufficient time for testing and distribution while managing storage costs.
      # Artifacts are automatically deleted after the retention period expires.
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-macOS
          retention-days: 90
          if-no-files-found: ignore
          path: |
            build/**/*.app
            build/**/*.vst3
            build/**/*.component

  build-windows:
    name: Build (Windows)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: windows-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Build with Visual Studio 2022
        run: |
          cd Builds\VisualStudio2022
          # Build shared code and helpers first
          msbuild ShowMIDI_SharedCode.vcxproj /p:Configuration=Release /p:Platform=x64
          msbuild ShowMIDI_VST3ManifestHelper.vcxproj /p:Configuration=Release /p:Platform=x64
          # Build plugin targets (skip VST2 - requires proprietary SDK)
          msbuild ShowMIDI_StandalonePlugin.vcxproj /p:Configuration=Release /p:Platform=x64
          msbuild ShowMIDI_VST3.vcxproj /p:Configuration=Release /p:Platform=x64
      
      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          if (Test-Path "Builds\VisualStudio2022\x64\Release\Standalone Plugin\ShowMIDI.exe") {
            Write-Host "✅ ShowMIDI.exe created successfully"
          } else {
            Write-Host "❌ ShowMIDI.exe not found"
            exit 1
          }
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-Windows
          retention-days: 90
          if-no-files-found: ignore
          path: |
            Builds/VisualStudio2022/x64/Release/**/*.exe
            Builds/VisualStudio2022/x64/Release/**/*.vst3
            build_clap/ShowMIDI_artefacts/Release/*.clap

  build-linux:
    name: Build (Linux)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config cmake \
            libasound2-dev libfreetype6-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j$(nproc)
      
      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          if [ -f "build/ShowMIDI_artefacts/Release/Standalone/ShowMIDI" ]; then
            echo "✅ ShowMIDI standalone binary created"
          else
            echo "⚠️  ShowMIDI standalone binary not found at expected location"
            echo "Searching for build artifacts..."
            find build -name "ShowMIDI" -o -name "*.so" -o -name "*.vst3"
          fi
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-Linux
          retention-days: 90
          if-no-files-found: ignore
          path: |
            build/ShowMIDI_artefacts/Release/**/*
            build_clap/ShowMIDI_artefacts/Release/*.clap

  # Test jobs: Run automated test suite on all platforms
  # Phase 4 (User Story 2): Cross-platform test execution
  test-macos:
    name: Test (macOS)
    needs: code-quality
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: brew install cmake ninja
      
      - name: Build tests
        run: |
          cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug -G Ninja
          cmake --build build --target ShowMIDI_Tests -j$(sysctl -n hw.ncpu)
      
      - name: Run unit tests
        run: |
          cd build
          ctest -L unit --output-on-failure --timeout 300
      
      - name: Run integration tests
        run: |
          cd build
          ctest -L integration --output-on-failure --timeout 300
      
      - name: Run system tests
        run: |
          cd build
          ctest -L system --output-on-failure --timeout 300
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-macos-${{ github.run_number }}
          retention-days: 90
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/*.xml
  
  test-windows:
    name: Test (Windows)
    needs: code-quality
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Build tests
        run: |
          cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
          cmake --build build --config Debug --target ShowMIDI_Tests
      
      - name: Run unit tests
        run: |
          cd build
          ctest -C Debug -L unit --output-on-failure --timeout 300
      
      - name: Run integration tests
        run: |
          cd build
          ctest -C Debug -L integration --output-on-failure --timeout 300
      
      - name: Run system tests
        run: |
          cd build
          ctest -C Debug -L system --output-on-failure --timeout 300
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-windows-${{ github.run_number }}
          retention-days: 90
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/*.xml
  
  test-linux:
    name: Test (Linux)
    needs: code-quality
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config cmake \
            libasound2-dev libfreetype6-dev libx11-dev \
            libxrandr-dev libxinerama-dev libxcursor-dev
      
      - name: Build tests
        run: |
          cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
          cmake --build build --target ShowMIDI_Tests -j$(nproc)
      
      - name: Run unit tests
        run: |
          cd build
          ctest -L unit --output-on-failure --timeout 300
      
      - name: Run integration tests
        run: |
          cd build
          ctest -L integration --output-on-failure --timeout 300
      
      - name: Run system tests
        run: |
          cd build
          ctest -L system --output-on-failure --timeout 300
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux-${{ github.run_number }}
          retention-days: 90
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/*.xml

  build-ios:
    name: Build (iOS AUv3)
    needs: code-quality  # Only run builds if code quality checks pass (fail-fast)
    runs-on: macos-latest
    # iOS build is optional - comment out if not needed
    if: false  # Enable this by changing to 'true' when iOS build is ready
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      # Adaptive Xcode Selection: GitHub Actions runner images regularly update Xcode versions.
      # This step uses xcode-select to detect and verify the active Xcode installation,
      # preventing "invalid developer directory" errors when runners update.
      # The workflow automatically uses the latest available Xcode on the runner.
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Build iOS AUv3
        run: |
          cd Builds/iOS
          xcodebuild -project ShowMIDI.xcodeproj \
            -scheme "ShowMIDI - AUv3 AppExtension" \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ShowMIDI-iOS
          path: Builds/iOS/build/Release-iphonesimulator/*.appex
