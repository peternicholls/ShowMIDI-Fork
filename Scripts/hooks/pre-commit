#!/usr/bin/env bash
#
# ShowMIDI Pre-Commit Hook
# Copyright (C) 2025 Peter Nicholls.  https://www.peternicholls.me.uk
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Purpose: Run formatting and linting checks before commit
#   - Auto-fix code with clang-format
#   - Check GPL-3.0 headers on new/modified files
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() { echo -e "${RED}✗ $*${NC}" >&2; }
success() { echo -e "${GREEN}✓ $*${NC}"; }
warning() { echo -e "${YELLOW}⚠ $*${NC}"; }

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check for clang-format
if ! command -v clang-format >/dev/null 2>&1; then
    warning "clang-format not found - skipping format check"
    warning "Install: brew install clang-format"
else
    # Get staged C++ files
    STAGED_CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|h|mm)$' || true)
    
    if [ -n "$STAGED_CPP_FILES" ]; then
        echo "Running clang-format on staged files..."
        
        for file in $STAGED_CPP_FILES; do
            if [ -f "$REPO_ROOT/$file" ]; then
                clang-format -i "$REPO_ROOT/$file"
                git add "$REPO_ROOT/$file"
                success "Formatted: $file"
            fi
        done
    fi
fi

# GPL Header Check
GPL_HEADER_PATTERN="GNU General Public License"
STAGED_SOURCE_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E '\.(cpp|h|mm)$' || true)

if [ -n "$STAGED_SOURCE_FILES" ]; then
    echo "Checking GPL-3.0 headers on new files..."
    
    MISSING_HEADERS=()
    for file in $STAGED_SOURCE_FILES; do
        if [ -f "$REPO_ROOT/$file" ]; then
            if ! head -n 20 "$REPO_ROOT/$file" | grep -q "$GPL_HEADER_PATTERN"; then
                MISSING_HEADERS+=("$file")
            fi
        fi
    done
    
    if [ ${#MISSING_HEADERS[@]} -gt 0 ]; then
        error "The following new files are missing GPL-3.0 headers:"
        for file in "${MISSING_HEADERS[@]}"; do
            error "  - $file"
        done
        echo ""
        echo "Please add the GPL-3.0 header. See existing files for template."
        exit 1
    fi
fi

success "Pre-commit checks passed"
exit 0
