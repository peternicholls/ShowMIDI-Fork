#!/usr/bin/env bash
#
# ShowMIDI Pre-Push Hook
# Copyright (C) 2025 Peter Nicholls.  https://www.peternicholls.me.uk
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Purpose: Run unit tests before pushing to remote
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() { echo -e "${RED}✗ $*${NC}" >&2; }
success() { echo -e "${GREEN}✓ $*${NC}"; }
info() { echo "$*"; }

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
BUILD_DIR="$REPO_ROOT/build"

# Check if build directory exists
if [ ! -d "$BUILD_DIR" ]; then
    error "Build directory not found at $BUILD_DIR"
    error "Please run: mkdir build && cd build && cmake .. && cmake --build ."
    exit 1
fi

# Check if CTest is available
if ! command -v ctest >/dev/null 2>&1; then
    error "CTest not found - cannot run unit tests"
    error "CTest is part of CMake. Install: brew install cmake"
    exit 1
fi

info "Running unit tests before push..."
echo ""

# Run unit tests
cd "$BUILD_DIR"

if ! ctest --output-on-failure -R "UnitTests" 2>&1; then
    echo ""
    error "Unit tests failed!"
    error "Fix the failing tests before pushing."
    error ""
    error "To bypass this check (emergencies only): git push --no-verify"
    exit 1
fi

echo ""
success "All unit tests passed!"
exit 0
